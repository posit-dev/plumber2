<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>Persistent server-side data storage — api_datastore • plumber2</title><!-- favicons --><link rel="icon" type="image/png" sizes="96x96" href="../favicon-96x96.png"><link rel="icon" type="”image/svg+xml”" href="../favicon.svg"><link rel="apple-touch-icon" sizes="180x180" href="../apple-touch-icon.png"><link rel="icon" sizes="any" href="../favicon.ico"><link rel="manifest" href="../site.webmanifest"><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet"><script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet"><link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet"><script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Persistent server-side data storage — api_datastore"><meta name="description" content="While using a session cookie is a convenient solution
to persistent data storage between requests it has the downside of requiring
the data to be passed back and forth between server and client at every
exchange. This makes it impractical for all but the smallest snippets of
data. An alternative strategy is to use server-side storage which this
function facilitates. It uses the firesale plugin under the hood to provide
a list-like interface to a storr-backed key-value store. storr in turn
provides interfaces to a range of backends such as redis, LMDB, and databases
supported by DBI. Further it provides simpler (but setup-free) solutions such
as using an environment (obviously less persistent) or a folder of rds files."><meta property="og:description" content="While using a session cookie is a convenient solution
to persistent data storage between requests it has the downside of requiring
the data to be passed back and forth between server and client at every
exchange. This makes it impractical for all but the smallest snippets of
data. An alternative strategy is to use server-side storage which this
function facilitates. It uses the firesale plugin under the hood to provide
a list-like interface to a storr-backed key-value store. storr in turn
provides interfaces to a range of backends such as redis, LMDB, and databases
supported by DBI. Further it provides simpler (but setup-free) solutions such
as using an environment (obviously less persistent) or a folder of rds files."><meta property="og:image" content="https://plumber2.posit.co/logo.svg"></head><body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">plumber2</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.1.0.9000</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto"><li class="nav-item"><a class="nav-link" href="../articles/plumber.html">Get Started</a></li>
<li class="active nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-learn-plumber-" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Learn plumber2</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-learn-plumber-"><li><a class="dropdown-item" href="../articles/introduction.html">1. Introduction</a></li>
    <li><a class="dropdown-item" href="../articles/routing-and-input.html">2. Routing &amp; Input</a></li>
    <li><a class="dropdown-item" href="../articles/rendering-output.html">3. Rendering output</a></li>
    <li><a class="dropdown-item" href="../articles/execution-model.html">4. Runtime</a></li>
    <li><a class="dropdown-item" href="../articles/hosting.html">5. Hosting</a></li>
    <li><a class="dropdown-item" href="../articles/programmatic-usage.html">6. Programmatic usage</a></li>
    <li><a class="dropdown-item" href="../articles/annotations.html">7. Annotation Reference</a></li>
    <li><a class="dropdown-item" href="../articles/security.html">8. Security</a></li>
    <li><a class="dropdown-item" href="../articles/tips-and-tricks.html">9. Tips &amp; Tricks</a></li>
    <li><a class="dropdown-item" href="../articles/migration.html">10. Migration</a></li>
  </ul></li>
      </ul><ul class="navbar-nav"><li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json"></form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/posit-dev/plumber2/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul></div>


  </div>
</nav><div class="container template-reference-topic">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.svg" class="logo" alt=""><h1>Persistent server-side data storage</h1>
      <small class="dont-index">Source: <a href="https://github.com/posit-dev/plumber2/blob/main/R/api_storage.R" class="external-link"><code>R/api_storage.R</code></a></small>
      <div class="d-none name"><code>api_datastore.Rd</code></div>
    </div>

    <div class="ref-description section level2">
    <p>While using a <a href="api_session_cookie.html">session cookie</a> is a convenient solution
to persistent data storage between requests it has the downside of requiring
the data to be passed back and forth between server and client at every
exchange. This makes it impractical for all but the smallest snippets of
data. An alternative strategy is to use server-side storage which this
function facilitates. It uses the firesale plugin under the hood to provide
a list-like interface to a storr-backed key-value store. storr in turn
provides interfaces to a range of backends such as redis, LMDB, and databases
supported by DBI. Further it provides simpler (but setup-free) solutions such
as using an environment (obviously less persistent) or a folder of rds files.</p>
    </div>

    <div class="section level2">
    <h2 id="ref-usage">Usage<a class="anchor" aria-label="anchor" href="#ref-usage"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span><span class="fu">api_datastore</span><span class="op">(</span></span>
<span>  <span class="va">api</span>,</span>
<span>  <span class="va">driver</span>,</span>
<span>  store_name <span class="op">=</span> <span class="st">"datastore"</span>,</span>
<span>  gc_interval <span class="op">=</span> <span class="fl">3600</span>,</span>
<span>  max_age <span class="op">=</span> <span class="va">gc_interval</span></span>
<span><span class="op">)</span></span></code></pre></div>
    </div>

    <div class="section level2">
    <h2 id="arguments">Arguments<a class="anchor" aria-label="anchor" href="#arguments"></a></h2>


<dl><dt id="arg-api">api<a class="anchor" aria-label="anchor" href="#arg-api"></a></dt>
<dd><p>A plumber2 api object to add the datastore setup to</p></dd>


<dt id="arg-driver">driver<a class="anchor" aria-label="anchor" href="#arg-driver"></a></dt>
<dd><p>A storr compatible driver that defines the backend of the
datastore</p></dd>


<dt id="arg-store-name">store_name<a class="anchor" aria-label="anchor" href="#arg-store-name"></a></dt>
<dd><p>The argument name under which the datastore will be
available to the request handlers</p></dd>


<dt id="arg-gc-interval">gc_interval<a class="anchor" aria-label="anchor" href="#arg-gc-interval"></a></dt>
<dd><p>The interval between running garbage collection on the
backend</p></dd>


<dt id="arg-max-age">max_age<a class="anchor" aria-label="anchor" href="#arg-max-age"></a></dt>
<dd><p>The time since last request to pass before a session store is
cleared</p></dd>

</dl></div>
    <div class="section level2">
    <h2 id="value">Value<a class="anchor" aria-label="anchor" href="#value"></a></h2>
    <p>These functions return the <code>api</code> object allowing for easy chaining
with the pipe</p>
    </div>
    <div class="section level2">
    <h2 id="details">Details<a class="anchor" aria-label="anchor" href="#details"></a></h2>
    <p>Once you turn the datastore on with this function your request handlers will
gain access to a new argument (defaults to <code>datastore</code> but this can be
changed with the <code>store_name</code> argument). The <code>datastore</code> argument will
contain a list holding two elements: <code>global</code> and <code>session</code> which in turn
will be list-like interfaces to the underlying key-value store. The <code>global</code>
element access a store shared by all sessions whereas the <code>session</code> element
is scoped to the current session. Depending on the value of <code>max_age</code> the
session specific data is purged once a certain amount of time has passed
since the last request from that session.</p>
    </div>
    <div class="section level2">
    <h2 id="using-annotation">Using annotation<a class="anchor" aria-label="anchor" href="#using-annotation"></a></h2>
    <p>Session cookie setup doesn't have a dedicated annotation tag, but you can set
it up in a <code>@plumber</code> block</p>
<p></p><div class="sourceCode"><pre><code><span id="cb1-1"><a href="#cb1-1" tabindex="-1"></a><span class="co">#* @plumber</span></span>
<span id="cb1-2"><a href="#cb1-2" tabindex="-1"></a><span class="cf">function</span>(api) {</span>
<span id="cb1-3"><a href="#cb1-3" tabindex="-1"></a>  api <span class="sc">|&gt;</span></span>
<span id="cb1-4"><a href="#cb1-4" tabindex="-1"></a>    <span class="fu">api_datastore</span>(storr<span class="sc">::</span><span class="fu">driver_dbi</span>(...))</span>
<span id="cb1-5"><a href="#cb1-5" tabindex="-1"></a>}</span></code></pre><p></p></div>
    </div>

    <div class="section level2">
    <h2 id="ref-examples">Examples<a class="anchor" aria-label="anchor" href="#ref-examples"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span class="r-in"><span><span class="fu"><a href="api.html">api</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span></span>
<span class="r-in"><span>  <span class="fu">api_datastore</span><span class="op">(</span><span class="fu">storr</span><span class="fu">::</span><span class="fu"><a href="https://richfitz.github.io/storr/reference/storr_environment.html" class="external-link">driver_environment</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span></span>
<span class="r-in"><span>  <span class="fu"><a href="api_request_handlers.html">api_get</a></span><span class="op">(</span><span class="st">"hello"</span>, <span class="kw">function</span><span class="op">(</span><span class="va">datastore</span><span class="op">)</span> <span class="op">{</span></span></span>
<span class="r-in"><span>    <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">datastore</span><span class="op">$</span><span class="va">session</span><span class="op">)</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span> <span class="op">{</span></span></span>
<span class="r-in"><span>      <span class="va">datastore</span><span class="op">$</span><span class="va">global</span><span class="op">$</span><span class="va">count</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="va">datastore</span><span class="op">$</span><span class="va">global</span><span class="op">$</span><span class="va">count</span> <span class="op"><a href="https://rdrr.io/r/base/Control.html" class="external-link">%||%</a></span> <span class="fl">0</span><span class="op">)</span> <span class="op">+</span> <span class="fl">1</span></span></span>
<span class="r-in"><span>      <span class="va">datastore</span><span class="op">$</span><span class="va">session</span><span class="op">$</span><span class="va">not_first_visit</span> <span class="op">&lt;-</span> <span class="cn">TRUE</span></span></span>
<span class="r-in"><span>      <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"Welcome. You are visitor #"</span>, <span class="va">datastore</span><span class="op">$</span><span class="va">global</span><span class="op">$</span><span class="va">count</span><span class="op">)</span></span></span>
<span class="r-in"><span>    <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span></span>
<span class="r-in"><span>      <span class="st">"Welcome back"</span></span></span>
<span class="r-in"><span>    <span class="op">}</span></span></span>
<span class="r-in"><span>  <span class="op">}</span><span class="op">)</span></span></span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> Creating <span style="color: #00BB00;">default</span> route in request router</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> ── A plumber server ────────────────────────────────────────────────────────────</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Serving on http://127.0.0.1:8080</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Currently <span style="color: #BB0000;">not running</span></span>
<span class="r-in"><span></span></span>
</code></pre></div>
    </div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside></div>


    <footer><div class="pkgdown-footer-left">
  <p>Developed by Thomas Lin Pedersen, Posit Software, PBC.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

    </footer></div>





  </body></html>

