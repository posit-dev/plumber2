<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>Add a handler to a WebSocket message — api_message • plumber2</title><!-- favicons --><link rel="icon" type="image/png" sizes="96x96" href="../favicon-96x96.png"><link rel="icon" type="”image/svg+xml”" href="../favicon.svg"><link rel="apple-touch-icon" sizes="180x180" href="../apple-touch-icon.png"><link rel="icon" sizes="any" href="../favicon.ico"><link rel="manifest" href="../site.webmanifest"><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet"><script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/Schibsted_Grotesk-0.4.10/font.css" rel="stylesheet"><link href="../deps/Fira_Code-0.4.10/font.css" rel="stylesheet"><link href="../deps/National_Park-0.4.10/font.css" rel="stylesheet"><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet"><link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet"><script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Add a handler to a WebSocket message — api_message"><meta name="description" content="WebSockets is a bidirectional communication channel that can be established
at the request of the client. While websocket communication is not really
part of a standard REST api, it has many uses and can easily be used together
with one."><meta property="og:description" content="WebSockets is a bidirectional communication channel that can be established
at the request of the client. While websocket communication is not really
part of a standard REST api, it has many uses and can easily be used together
with one."><meta property="og:image" content="https://plumber2.posit.co/logo.svg"></head><body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">plumber2</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.1.0.9000</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto"><li class="nav-item"><a class="nav-link" href="../articles/plumber.html">Get Started</a></li>
<li class="active nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-learn-plumber-" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Learn plumber2</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-learn-plumber-"><li><a class="dropdown-item" href="../articles/introduction.html">1. Introduction</a></li>
    <li><a class="dropdown-item" href="../articles/routing-and-input.html">2. Routing &amp; Input</a></li>
    <li><a class="dropdown-item" href="../articles/rendering-output.html">3. Rendering output</a></li>
    <li><a class="dropdown-item" href="../articles/execution-model.html">4. Runtime</a></li>
    <li><a class="dropdown-item" href="../articles/hosting.html">5. Hosting</a></li>
    <li><a class="dropdown-item" href="../articles/programmatic-usage.html">6. Programmatic usage</a></li>
    <li><a class="dropdown-item" href="../articles/annotations.html">7. Annotation Reference</a></li>
    <li><a class="dropdown-item" href="../articles/security.html">8. Security</a></li>
    <li><a class="dropdown-item" href="../articles/tips-and-tricks.html">9. Tips &amp; Tricks</a></li>
    <li><a class="dropdown-item" href="../articles/migration.html">10. Migration</a></li>
  </ul></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-advanced" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Advanced</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-advanced"><li><a class="dropdown-item" href="../articles/extending.html">Extending plumber2</a></li>
    <li><a class="dropdown-item" href="../articles/server_yml.html">The _server.yml standard</a></li>
    <li><a class="dropdown-item" href="../articles/otel.html">OpenTelemetry instrumentation</a></li>
  </ul></li>
      </ul><ul class="navbar-nav"><li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json"></form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/posit-dev/plumber2/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul></div>


  </div>
</nav><div class="container template-reference-topic">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.svg" class="logo" alt=""><h1>Add a handler to a WebSocket message</h1>
      <small class="dont-index">Source: <a href="https://github.com/posit-dev/plumber2/blob/main/R/api_handlers.R" class="external-link"><code>R/api_handlers.R</code></a></small>
      <div class="d-none name"><code>api_message.Rd</code></div>
    </div>

    <div class="ref-description section level2">
    <p>WebSockets is a bidirectional communication channel that can be established
at the request of the client. While websocket communication is not really
part of a standard REST api, it has many uses and can easily be used together
with one.</p>
    </div>

    <div class="section level2">
    <h2 id="ref-usage">Usage<a class="anchor" aria-label="anchor" href="#ref-usage"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span><span class="fu">api_message</span><span class="op">(</span><span class="va">api</span>, <span class="va">handler</span>, async <span class="op">=</span> <span class="cn">NULL</span>, then <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span></span></code></pre></div>
    </div>

    <div class="section level2">
    <h2 id="arguments">Arguments<a class="anchor" aria-label="anchor" href="#arguments"></a></h2>


<dl><dt id="arg-api">api<a class="anchor" aria-label="anchor" href="#arg-api"></a></dt>
<dd><p>A plumber2 api object to add the handler to</p></dd>


<dt id="arg-handler">handler<a class="anchor" aria-label="anchor" href="#arg-handler"></a></dt>
<dd><p>A function conforming to the specifications laid out in
Details</p></dd>


<dt id="arg-async">async<a class="anchor" aria-label="anchor" href="#arg-async"></a></dt>
<dd><p>If <code>FALSE</code> create a regular handler. If <code>TRUE</code>, use the default
async evaluator to create an async handler. If a string, the async evaluator
registered to that name is used. If a function is provided then this is used
as the async evaluator. See the <em>Async</em> section for more detail</p></dd>


<dt id="arg-then">then<a class="anchor" aria-label="anchor" href="#arg-then"></a></dt>
<dd><p>A list of function to be called once the async handler is done.
The functions will be chained using <code><a href="https://rstudio.github.io/promises/reference/then.html" class="external-link">promises::then()</a></code>. See the <em>Async</em>
section for more detail</p></dd>

</dl></div>
    <div class="section level2">
    <h2 id="value">Value<a class="anchor" aria-label="anchor" href="#value"></a></h2>
    <p>This functions return the <code>api</code> object allowing for easy chaining
with the pipe</p>
    </div>
    <div class="section level2">
    <h2 id="details">Details<a class="anchor" aria-label="anchor" href="#details"></a></h2>
    <p>A handler for a websocket message is much simpler than for requests in
general since it doesn't have to concern itself with methods, paths, and
responses. Any message handler registered will get called in sequence when a
websocket message is recieved from a client. Still, a few expectations apply</p><div class="section">
<h3 id="handler-arguments">Handler Arguments<a class="anchor" aria-label="anchor" href="#handler-arguments"></a></h3>


<p>The handler can take any of the following arguments:</p><ul><li><p><code>message</code>: Either a raw vector if the message recieved is in binary form or
a single string, giving the message sent from the client</p></li>
<li><p><code>server</code>: The <a href="Plumber2.html">Plumber2</a> object representing your server implementation</p></li>
<li><p><code>client_id</code>: A string uniquely identifying the session the request comes
from</p></li>
<li><p><code>request</code>: The request that was initially used to establish the websocket
connection with the client as a <a href="https://reqres.data-imaginist.com/reference/Request.html" class="external-link">reqres::Request</a> object</p></li>
</ul></div>

<div class="section">
<h3 id="handler-return-value">Handler Return Value<a class="anchor" aria-label="anchor" href="#handler-return-value"></a></h3>


<p>It is not expected that a websocket message sends a response and thus the
handler is not required to do anything like that. However, if the handler
returns either a raw vector or a single string it is taken as a signal to
send this back to the client. Any other return value is silently ignored.</p>
</div>

    </div>
    <div class="section level2">
    <h2 id="async">Async<a class="anchor" aria-label="anchor" href="#async"></a></h2>
    <p>You can handle websocket messages asynchronously if needed. Like with
<a href="api_request_handlers.html">request handlers</a> you can either do it manually by creating and
returning a promise inside the handler, or by letting plumber2 convert your
handler to an async handler using the <code>async</code> argument. Due to the nature of
promises a handler being converted to a promise can't take <code>request</code> and
<code>server</code> arguments, so if you need to manipulate these you need to use <code>then</code>
(more on this shortly). The same conventions about return value holds for
async message handlers as for regular ones.</p><div class="section">
<h3 id="async-chaining">Async chaining<a class="anchor" aria-label="anchor" href="#async-chaining"></a></h3>


<p>Because you can't manipulate <code>request</code> or <code>server</code> in the async handler it
may be needed to add operations to perform once the async handler has
finished. This can be done through the <code>then</code> argument. This takes a list of
functions to chain to the promise using <code><a href="https://rstudio.github.io/promises/reference/then.html" class="external-link">promises::then()</a></code>. Before the <code>then</code>
chain is executed the return value of the async handler will be send back to
the client if it is a string or a raw vector. Each <code>then</code> call will receive
the same arguments as a standard message handler as well as <code>result</code> which
will hold the return value of the previous handler in the chain. For the
first <code>then</code> call <code>result</code> will be whatever the main async handler returned.
The return value of the last call in the chain will be silently ignored.</p>
</div>

    </div>
    <div class="section level2">
    <h2 id="using-annotation">Using annotation<a class="anchor" aria-label="anchor" href="#using-annotation"></a></h2>
    <p>A websocket message handler can be added to an API in an annotated route file
by using the <code>@message</code> tag</p>
<p></p><div class="sourceCode"><pre><code><span id="cb1-1"><a href="#cb1-1" tabindex="-1"></a><span class="co">#* @message</span></span>
<span id="cb1-2"><a href="#cb1-2" tabindex="-1"></a><span class="cf">function</span>(message) {</span>
<span id="cb1-3"><a href="#cb1-3" tabindex="-1"></a>  <span class="cf">if</span> (message <span class="sc">==</span> <span class="st">"Hello"</span>) {</span>
<span id="cb1-4"><a href="#cb1-4" tabindex="-1"></a>    <span class="fu">return</span>(<span class="st">"Hello, you..."</span>)</span>
<span id="cb1-5"><a href="#cb1-5" tabindex="-1"></a>  }</span>
<span id="cb1-6"><a href="#cb1-6" tabindex="-1"></a>}</span></code></pre><p></p></div>
<p>You can create async handlers with <code>then</code> chaining using annotation, through
the <code>@async</code> and <code>@then</code> tags</p>
<p></p><div class="sourceCode"><pre><code><span id="cb1-1"><a href="#cb1-1" tabindex="-1"></a><span class="co">#* @message</span></span>
<span id="cb1-2"><a href="#cb1-2" tabindex="-1"></a><span class="co">#* @async</span></span>
<span id="cb1-3"><a href="#cb1-3" tabindex="-1"></a><span class="cf">function</span>(message) {</span>
<span id="cb1-4"><a href="#cb1-4" tabindex="-1"></a>  <span class="cf">if</span> (message <span class="sc">==</span> <span class="st">"Hello"</span>) {</span>
<span id="cb1-5"><a href="#cb1-5" tabindex="-1"></a>    <span class="fu">return</span>(<span class="st">"Hello, you..."</span>)</span>
<span id="cb1-6"><a href="#cb1-6" tabindex="-1"></a>  }</span>
<span id="cb1-7"><a href="#cb1-7" tabindex="-1"></a>}</span>
<span id="cb1-8"><a href="#cb1-8" tabindex="-1"></a><span class="co">#* @then</span></span>
<span id="cb1-9"><a href="#cb1-9" tabindex="-1"></a><span class="cf">function</span>(server) {</span>
<span id="cb1-10"><a href="#cb1-10" tabindex="-1"></a>  server<span class="sc">$</span><span class="fu">log</span>(<span class="st">"message"</span>, <span class="st">"websocket message received"</span>)</span>
<span id="cb1-11"><a href="#cb1-11" tabindex="-1"></a>}</span></code></pre><p></p></div>
    </div>

    <div class="section level2">
    <h2 id="ref-examples">Examples<a class="anchor" aria-label="anchor" href="#ref-examples"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span class="r-in"><span><span class="fu"><a href="api.html">api</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span></span>
<span class="r-in"><span>  <span class="fu">api_message</span><span class="op">(</span></span></span>
<span class="r-in"><span>    <span class="kw">function</span><span class="op">(</span><span class="va">message</span><span class="op">)</span> <span class="op">{</span></span></span>
<span class="r-in"><span>      <span class="kw">if</span> <span class="op">(</span><span class="va">message</span> <span class="op">==</span> <span class="st">"Hello"</span><span class="op">)</span> <span class="op">{</span></span></span>
<span class="r-in"><span>        <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="st">"Hello, you..."</span><span class="op">)</span></span></span>
<span class="r-in"><span>      <span class="op">}</span></span></span>
<span class="r-in"><span>    <span class="op">}</span></span></span>
<span class="r-in"><span>  <span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> ── A plumber server ────────────────────────────────────────────────────────────</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Serving on http://127.0.0.1:8080</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Currently <span style="color: #BB0000;">not running</span></span>
<span class="r-in"><span></span></span>
</code></pre></div>
    </div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside></div>


    <footer><div class="pkgdown-footer-left">
  <p>Developed by Thomas Lin Pedersen, Posit Software, PBC.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

    </footer></div>





  </body></html>

