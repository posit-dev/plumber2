<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Instrumentation with OpenTelemetry • plumber2</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="96x96" href="../favicon-96x96.png">
<link rel="icon" type="”image/svg+xml”" href="../favicon.svg">
<link rel="apple-touch-icon" sizes="180x180" href="../apple-touch-icon.png">
<link rel="icon" sizes="any" href="../favicon.ico">
<link rel="manifest" href="../site.webmanifest">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/Schibsted_Grotesk-0.4.10/font.css" rel="stylesheet">
<link href="../deps/Fira_Code-0.4.10/font.css" rel="stylesheet">
<link href="../deps/National_Park-0.4.10/font.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><script src="otel_files/libs/quarto-html/popper.min.js"></script><script src="otel_files/libs/quarto-html/tippy.umd.min.js"></script><link href="otel_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="otel_files/libs/quarto-html/light-border.css" rel="stylesheet">
<!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Instrumentation with OpenTelemetry">
<meta property="og:image" content="https://plumber2.posit.co/logo.svg">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">plumber2</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.1.0.9000</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../articles/plumber.html">Get Started</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-learn-plumber-" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Learn plumber2</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-learn-plumber-">
<li><a class="dropdown-item" href="../articles/introduction.html">1. Introduction</a></li>
    <li><a class="dropdown-item" href="../articles/routing-and-input.html">2. Routing &amp; Input</a></li>
    <li><a class="dropdown-item" href="../articles/rendering-output.html">3. Rendering output</a></li>
    <li><a class="dropdown-item" href="../articles/execution-model.html">4. Runtime</a></li>
    <li><a class="dropdown-item" href="../articles/hosting.html">5. Hosting</a></li>
    <li><a class="dropdown-item" href="../articles/programmatic-usage.html">6. Programmatic usage</a></li>
    <li><a class="dropdown-item" href="../articles/annotations.html">7. Annotation Reference</a></li>
    <li><a class="dropdown-item" href="../articles/security.html">8. Security</a></li>
    <li><a class="dropdown-item" href="../articles/tips-and-tricks.html">9. Tips &amp; Tricks</a></li>
    <li><a class="dropdown-item" href="../articles/migration.html">10. Migration</a></li>
  </ul>
</li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-advanced" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Advanced</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-advanced">
<li><a class="dropdown-item" href="../articles/extending.html">Extending plumber2</a></li>
    <li><a class="dropdown-item" href="../articles/server_yml.html">The _server.yml standard</a></li>
    <li><a class="dropdown-item" href="../articles/otel.html">OpenTelemetry instrumentation</a></li>
  </ul>
</li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/posit-dev/plumber2/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-quarto">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.svg" class="logo" alt=""><h1>Instrumentation with OpenTelemetry</h1>




      <small class="dont-index">Source: <a href="https://github.com/posit-dev/plumber2/blob/main/vignettes/otel.qmd" class="external-link"><code>vignettes/otel.qmd</code></a></small>
      <div class="d-none name"><code></code></div>
    </div>






    <p>Monitoring your server is crucial once it is up and running. This monitoring can come in many forms, ranging from classic logging and all the way up to collecting metrics such as number of concurrent requests being handled at any given point in time. <a href="https://opentelemetry.io" class="external-link">OpenTelemetry</a> is a standard for collecting such instrumentation which in R is available in the <a href="https://otel.r-lib.org" class="external-link">otel</a> package. It includes support for traces (hierarchical spans of operations), logs, and metrics and it comes with a huge and detailed set of semantics for how these should be formatted and which information to include.</p>
<p>plumber2 provides expansive support for otel, though all the actual support is implemented in the underlying packages reqres, fiery, and routr (this also means that all we discuss here will translated to barebone fiery servers). This document will detail the various ways in which instrumentation is supported and how you may add to it in your own servers, should you choose to.</p>
<p>Understanding how to turn on otel instrumentation is not part of this document. You should consult the otel package for learning about this.</p>
<section class="level2"><h2 id="traces">Traces<a class="anchor" aria-label="anchor" href="#traces"></a>
</h2>
<p>OpenTelemetry comes with an expansive <a href="https://opentelemetry.io/docs/specs/semconv/http/http-spans/#http-server" class="external-link">semantic convention</a> for how servers should record their handling of HTTP requests, which has been fully implemented in reqres.</p>
<p>Once a request is received a span is created and attached to the request. It is available in the <code>otel</code> field (e.g. <code>request$otel</code>) and will be <code>NULL</code> if instrumentation is not turned on. The span is automatically closed when the response is send back.</p>
<p>To the extent possible, the span will capture all the attributes mentioned in the conventions and should be used as the parent span for all subspans that are part of handling this request (this will happen automatically for user-initiated spans). If the request comes with a span context from the client then this will be used as parent for the reqres span.</p>
<p>Apart from the attributes mentioned in the semantics, fiery will add three attributes to this span:</p>
<ul>
<li>
<code>server.id</code> will hold the unique id of the server handling the request. If you have multiple servers running in parallel each will have their own unique id.</li>
<li>
<code>server.framework.name</code> will hold the name of the framework used to create the server (“plumber2” for a plumber2 api, “fiery” for a barebone fiery server, or something else if others choose to build a framework on top of fiery)</li>
<li>
<code>server.framework.version</code> will hold the version of the framework (the package version)</li>
</ul>
<section class="level3"><h3 id="subtraces">Subtraces<a class="anchor" aria-label="anchor" href="#subtraces"></a>
</h3>
<p>You are often interested in what goes on during handling of the request. For plumber2 this usually means the different routes the request is passed through. routr, which handles the routes, will automatically create a subspan for each of the routes a request goes through and activate that span (meaning that any spans created within the route logic will get this span as a parent). Since all the attributes described in the semantic conventions are already recorded in the parent span it will not be repeated in the subspan. Instead, the subspan created by routr will contain the following attributes:</p>
<ul>
<li>
<code>routr.route</code> holds the path of the route the request was matched to. Be aware that routr has a different path naming convention than plumber2 and the attribute will use the routr naming. Here, path parameters are prefixed with <code>:</code> rather than being enclosed in angle braces. So, if you have a plumber2 path like <code>/users/&lt;username&gt;/settings</code> it will appear in the subspan as <code>/users/:username/settings</code>
</li>
<li>
<code>routr.path.param.&lt;name&gt;</code> will hold the actual parameter of the path param. Be aware that there can be multiple of these. Continuing the example from a above, a url path of <code>/users/thomasp85/settings</code> will give rise to an <code>routr.path.param.username</code> attribute with a value of <code>"thomasp85"</code>.</li>
</ul>
<p>Apart from creating this subspan, routr also takes responsibility of setting the <code>http.route</code> attribute on the parent span (the one created by reqres). This attribute is part of the semantic convention but is not known by reqres so must be set by the code handling the request. The attribute will be set if the route path does not contain any wildcards. This means that it can in theory be overwritten multiple times during handling and the last route that satisfies the specificity requirement will win.</p>
<p>If you wish to add additional instrumentation to your server logic you’ll likely do this within your endpoint handlers. If so, you should probably use <code><a href="https://otel.r-lib.org/reference/start_local_active_span.html" class="external-link">otel::start_local_active_span()</a></code> which will automatically close itself at the end of your code and pick up the active routr subspan as the parent. However, don’t go overboard and only add instrumentation for things your are specifically interested in collecting. The default instrumentation is already quite detailed. An alternative way to add additional information is to add your own attributes or events to the spans already in place. As mentioned above, the parent span is available in <code>request$otel</code>, while the routr span can be accessed using <code><a href="https://otel.r-lib.org/reference/get_active_span.html" class="external-link">otel::get_active_span()</a></code>.</p>
</section></section><section class="level2"><h2 id="metrics">Metrics<a class="anchor" aria-label="anchor" href="#metrics"></a>
</h2>
<p>The HTTP semantic convention also covers metrics. reqres takes care of collecting those from the convention which are:</p>
<ul>
<li>
<code>http.server.request.duration</code> collects the duration of the request handling by the server</li>
<li>
<code>http.server.active_requests</code> collects the number of active requests at any point in time</li>
<li>
<code>http.server.request.body.size</code> collects the size of the body of requests received</li>
<li>
<code>http.server.response.body.size</code> collects the size of the body of responses send back</li>
</ul>
<p>You can define your own metrics if you wish and collect them during your endpoint logic. If you do so, make sure to use the request span (<code>request$otel</code>) as the context for the metric so it gets correctly linked (assuming the metric is related to request handling)</p>
</section><section class="level2"><h2 id="logs">Logs<a class="anchor" aria-label="anchor" href="#logs"></a>
</h2>
<p>fiery, and hence plumber2, has build in facility for logging and comes with a plethora of different loggers. You choose the logger with <code><a href="../reference/api_logger.html">api_logger()</a></code> and then log information using either <code>server$log()</code> (<code>server</code> being the plumber2 api object), or by throwing errors, warnings, or messages using whatever means you prefer (base, rlang, cli, etc).</p>
<p>fiery and plumber2 comes with a <code>logger_otel</code> which you can use to collect the logs with OpenTelemetry.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pa</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/api.html">api</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="../reference/api_logger.html">api_logger</a></span><span class="op">(</span><span class="fu"><a href="../reference/api_logger.html">logger_otel</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
</div>
<p>If you use this logger then all logs will appear together with your spans and metrics. If a log occur during request handling then the log will automatically be associated with the request span. Further, all logs will get the attribute <code>server.id</code> which identifies the server instance from which the log originated.</p>
</section><script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'light-border',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config);
    }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script></main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>


    <footer><div class="pkgdown-footer-left">
  <p>Developed by Thomas Lin Pedersen, Posit Software, PBC.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

    </footer>
</div>





  </body>
</html>
