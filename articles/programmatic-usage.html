<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Programmatic Usage • plumber2</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><script src="programmatic-usage_files/libs/quarto-html/popper.min.js"></script><script src="programmatic-usage_files/libs/quarto-html/tippy.umd.min.js"></script><link href="programmatic-usage_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="programmatic-usage_files/libs/quarto-html/light-border.css" rel="stylesheet">
<!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Programmatic Usage">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">plumber2</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.0.0.9000</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../articles/plumber.html">Get Started</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-learn-plumber-" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Learn plumber2</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-learn-plumber-">
<li><a class="dropdown-item" href="../articles/introduction.html">1. Introduction</a></li>
    <li><a class="dropdown-item" href="../articles/routing-and-input.html">2. Routing &amp; Input</a></li>
    <li><a class="dropdown-item" href="../articles/rendering-output.html">3. Rendering output</a></li>
    <li><a class="dropdown-item" href="../articles/execution-model.html">4. Runtime</a></li>
    <li><a class="dropdown-item" href="../articles/hosting.html">5. Hosting</a></li>
    <li><a class="dropdown-item" href="../articles/programmatic-usage.html">6. Programmatic usage</a></li>
    <li><a class="dropdown-item" href="../articles/annotations.html">7. Annotation Reference</a></li>
    <li><a class="dropdown-item" href="../articles/security.html">8. Security</a></li>
    <li><a class="dropdown-item" href="../articles/tips-and-tricks.html">9. Tips &amp; Tricks</a></li>
    <li><a class="dropdown-item" href="../articles/migration.html">10. Migration</a></li>
  </ul>
</li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/posit-dev/plumber2/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-quarto">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Programmatic Usage</h1>




      <small class="dont-index">Source: <a href="https://github.com/posit-dev/plumber2/blob/main/vignettes/programmatic-usage.qmd" class="external-link"><code>vignettes/programmatic-usage.qmd</code></a></small>
      <div class="d-none name"><code></code></div>
    </div>






    <p>Typically, users define APIs using the “annotations,” or special comments in their API source code. It is possible to define a Plumber API programmatically using the same underlying R6 objects that get created automatically when you define your API using annotations. Interacting with Plumber2 at this level can offer more control and specificity about how you want your API to behave. It further opens you up to the full power of <a href="https://fiery.data-imaginist.com/index.html" class="external-link">fiery</a>, upon which plumber2 is build. However, using annotated files will automatically provide you with OpenAPI documentation so in many cases using annotated files will be the obvious starting point.</p>
<section class="level2"><h2 id="creating-and-controlling-routers">Creating and Controlling routers<a class="anchor" aria-label="anchor" href="#creating-and-controlling-routers"></a>
</h2>
<p>Most of the work you do on a plumber2 API will be related to the request router. A router is the entity that funnels requests to the correct handler based on their path. The router used by plumber2 is provided by the <a href="https://routr.data-imaginist.com" class="external-link">routr</a> package and can be interacted with directly through the <code>request_router</code> field in your plumber API object. Often though, you will only interact with it indirectly through other functions and methods.</p>
<p>A router can contain multiple routes and each route can contain multiple path handlers. When a request is received the router will pass it through each route in turn. Each route will then select a handler (if one exist) for the request and execute that handler on the request. It is possible for a handler to signal that no further processing should happen in which case any remaining routes in the router is skipped and the response is send immediately.</p>
<p>When you create a plumber api based on multiple files each file will define their own route named after the file and the routes will be ordered by the order of the inputs. If you instead create your API programmatically you can create a new route by calling <code><a href="../reference/api_add_route.html">api_add_route()</a></code> or by naming a non-existing route when you add a handler. In the latter case the route will be placed in the end of the stack whereas adding it explicitly with the former approach allows you to insert it at any location in the router you wish. You may also use <code><a href="../reference/api_add_route.html">api_add_route()</a></code> to add an already defined routr route to your api.</p>
</section><section class="level2"><h2 id="defining-handlers">Defining handlers<a class="anchor" aria-label="anchor" href="#defining-handlers"></a>
</h2>
<p>You can add handlers to your router by using <code><a href="../reference/api_request_handlers.html">api_get()</a></code>, <code><a href="../reference/api_request_handlers.html">api_post()</a></code>, or one of the other handler functions. For instance, to define a Plumber API that responds to <code>GET</code> requests on <code>/</code> and <code>POST</code> requests on <code>/submit</code>, you could use the following code:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/api.html">api</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/api_request_handlers.html">api_get</a></span><span class="op">(</span><span class="st">"/"</span>, <span class="kw">function</span><span class="op">(</span><span class="va">req</span>, <span class="va">res</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="co"># ...</span></span>
<span>  <span class="op">}</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/api_request_handlers.html">api_post</a></span><span class="op">(</span><span class="st">"/submit"</span>, <span class="kw">function</span><span class="op">(</span><span class="va">req</span>, <span class="va">res</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="co"># ...</span></span>
<span>  <span class="op">}</span><span class="op">)</span></span></code></pre></div>
<p>The handler functions that you define in these calls are identical to the code you would have defined in your annotated file if you were using annotations to define your API.</p>
<p>The handler functions take additional arguments that allow you to control nuanced behavior of the handler like which serializer(s) it should use. For instance, the following endpoint would use the default HTML serializer from plumber2.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/api.html">api</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu"><a href="../reference/api_request_handlers.html">api_get</a></span><span class="op">(</span></span>
<span>    path <span class="op">=</span> <span class="st">"/"</span>,</span>
<span>    handler <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span><span class="op">{</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>        body <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>          h1 <span class="op">=</span> <span class="st">"Programmatic Plumber!"</span></span>
<span>        <span class="op">)</span></span>
<span>      <span class="op">)</span></span>
<span>    <span class="op">}</span>,</span>
<span>    serializers <span class="op">=</span> <span class="fu"><a href="../reference/register_serializer.html">get_serializers</a></span><span class="op">(</span><span class="st">"html"</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
<p>It is worth noting that there is a difference between adding handlers with the handler functions provided by plumber2 and <code>routr::Route$add_handler()</code> even though the former is based on the latter. With the latter approach the handler is added <em>as-is</em> and you’ll use routr’s syntax for path variables (prefixing the path element with <code>:</code> rather than enclosing it in <code>&lt;&gt;</code>). With the former the handler is wrapped in another function that talkes care of much of the plumber2 “magic”, such as setting parsers and serializers, providing type casting, and supporting graphic output. Unless you specifically want to opt out of this you’d be best served using the plumber2 provided handler functions.</p>
<p>One place where you may want to consider foregoing the plumber API altogether is if you are writing a plugin and you want that plugin to be usable by all fiery apps and not only plumber APIs.</p>
</section><section class="level2"><h2 id="listening-for-and-triggering-events">Listening for and triggering events<a class="anchor" aria-label="anchor" href="#listening-for-and-triggering-events"></a>
</h2>
<p>Plumber2 is build upon fiery which is an event-driven web server framework. During the course of running several events will fire and event handlers will be triggered (e.g. the router is listening for <code>"request"</code> events). While you should generally rely on the router for handling request event to ensure that requests are handled in a structured manner, you might want to attach handlers to other events, such as e.g. the <code>"start"</code> and <code>"end"</code> events. You can do this using the <code><a href="../reference/api_on.html">api_on()</a></code> function:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/api.html">api</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/api_on.html">api_on</a></span><span class="op">(</span><span class="st">"start"</span>, <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="st">"Yay! I'm starting up"</span><span class="op">)</span></span>
<span>  <span class="op">}</span><span class="op">)</span></span></code></pre></div>
<p>You can read more about the event cycle of a fiery app on the <a href="https://fiery.data-imaginist.com/articles/events.html" class="external-link">fiery website</a>.</p>
<p>You are not restricted to only listening for predefined events. You can add handlers to any event you wish, but you’ll need to trigger the event manually if it is not one of the predefined ones.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">papi</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/api.html">api</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/api_on.html">api_on</a></span><span class="op">(</span><span class="st">"hello"</span>, <span class="kw">function</span><span class="op">(</span><span class="va">name</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="st">"Hello"</span>, <span class="va">name</span><span class="op">)</span></span>
<span>  <span class="op">}</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## Somewhere in your server code</span></span>
<span><span class="va">papi</span><span class="op">$</span><span class="fu">trigger</span><span class="op">(</span><span class="st">"hello"</span>, name <span class="op">=</span> <span class="st">"Thomas"</span><span class="op">)</span></span></code></pre></div>
</section><section class="level2"><h2 id="mount-static">Static File Routers<a class="anchor" aria-label="anchor" href="#mount-static"></a>
</h2>
<p>Static files can be served in two different manners. Either using a specialized route attached to the router, or by completely circumventing the R session and serving the files directly. The former approach is more flexible, while the latter is more performant</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Serving files as a standard route</span></span>
<span><span class="fu"><a href="../reference/api.html">api</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/api_assets.html">api_assets</a></span><span class="op">(</span><span class="st">"/assets"</span>, <span class="st">"./myfiles"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/api_run.html">api_run</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Serving files directly</span></span>
<span><span class="fu"><a href="../reference/api.html">api</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/api_assets.html">api_statics</a></span><span class="op">(</span><span class="st">"/assets"</span>, <span class="st">"./myfiles"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/api_run.html">api_run</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p>This will make the files and directories stored in the <code>./myfiles</code> directory available on your API under the <code>/assets/</code> path.</p>
</section><script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'light-border',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config);
    }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script></main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>


    <footer><div class="pkgdown-footer-left">
  <p>Developed by Thomas Lin Pedersen.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.2.</p>
</div>

    </footer>
</div>





  </body>
</html>
